<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Generator with Logo</title>
    <!-- Include qrcode.js library from CDN -->
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
    ></script>

    <style>
      /* Basic Reset & Modern Font */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
          "Segoe UI Symbol";
        line-height: 1.6;
        background-color: #f4f7f9;
        color: #333;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      /* Main Container */
      .container {
        background-color: #ffffff;
        padding: 30px 40px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        max-width: 700px;
        width: 100%;
        text-align: center;
      }

      h1 {
        color: #2c3e50;
        margin-bottom: 25px;
        font-weight: 600;
      }

      /* AdSense Placeholder */
      .adsense-placeholder {
        background-color: #e9ecef;
        border: 1px dashed #ced4da;
        height: 90px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 25px auto;
        color: #6c757d;
        font-size: 0.9em;
        text-align: center;
        padding: 10px;
        max-width: 100%;
        border-radius: 5px;
      }

      /* Input & Preview Layout */
      .content-wrapper {
        display: flex;
        flex-direction: column;
        gap: 30px;
        align-items: flex-start;
        width: 100%;
      }

      @media (min-width: 650px) {
        /* Side-by-side on larger screens */
        .content-wrapper {
          flex-direction: row;
          align-items: flex-start;
        }
        .input-section,
        .preview-section {
          flex: 1;
        }
        .preview-section {
          margin-left: 20px;
        }
      }

      /* Input Section */
      .input-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
      }

      .form-group {
        text-align: left;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
      }

      textarea,
      input[type="file"] {
        width: 100%;
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        font-size: 1rem;
        transition: border-color 0.2s ease;
      }

      textarea {
        min-height: 100px;
        resize: vertical;
      }

      textarea:focus,
      input[type="file"]:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }

      input[type="file"] {
        padding: 5px;
        line-height: 1.8;
      }

      /* Logo Preview */
      .logo-preview-container {
        text-align: left;
        margin-top: 5px;
        height: 70px; /* Reserve space */
        position: relative; /* For positioning clear button */
      }

      #logoPreview {
        max-width: 60px;
        max-height: 60px;
        border-radius: 4px;
        border: 1px solid #eee;
        display: none; /* Hidden initially */
        margin-top: 5px;
        vertical-align: middle;
      }

      #clearLogoBtn {
        margin-left: 10px;
        padding: 3px 8px;
        font-size: 0.8em;
        cursor: pointer;
        display: none; /* Hidden initially */
        vertical-align: middle;
        background-color: #f1f1f1;
        border: 1px solid #ccc;
        border-radius: 3px;
        color: #555;
      }
      #clearLogoBtn:hover {
        background-color: #e0e0e0;
      }
      .logo-tip {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 5px;
        display: block;
      }

      /* Buttons */
      button#generateBtn {
        /* More specific selector */
        padding: 12px 25px;
        font-size: 1rem;
        font-weight: 500;
        color: #fff;
        background-color: #007bff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        margin-top: 10px;
        width: 100%;
      }

      button#generateBtn:hover {
        background-color: #0056b3;
      }

      /* Preview Section */
      .preview-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        width: 100%;
      }

      h2 {
        color: #495057;
        font-weight: 500;
        margin-bottom: 0;
        text-align: center;
        width: 100%;
      }

      #qrcode {
        width: 260px; /* Container size */
        height: 260px;
        border: 1px solid #e0e0e0;
        padding: 5px; /* Minimal padding */
        background-color: #fff;
        border-radius: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
        position: relative; /* Needed if we absolute position things inside */
      }
      /* Ensure canvas/img fills container padding */
      #qrcode canvas,
      #qrcode img {
        max-width: 100%;
        max-height: 100%;
        display: block;
      }

      #downloadBtn {
        background-color: #28a745;
        padding: 12px 25px; /* Match generate button */
        font-size: 1rem; /* Match generate button */
        font-weight: 500; /* Match generate button */
        border: none; /* Match generate button */
        border-radius: 5px; /* Match generate button */
        width: 100%; /* Match generate button */
        cursor: pointer; /* Match generate button */
        transition: background-color 0.2s ease; /* Match generate button */
        color: #fff; /* Match generate button */
      }
      #downloadBtn:hover {
        background-color: #218838;
      }
      #downloadBtn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      /* Footer */
      footer {
        margin-top: 40px;
        font-size: 0.9em;
        color: #6c757d;
        text-align: center;
      }
      footer a {
        color: #007bff;
        text-decoration: none;
      }
      footer a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>QR Code Generator</h1>

      <!-- AdSense Placeholder Section -->
      <div class="adsense-placeholder">
        <!-- YOUR ADSENSE CODE HERE -->
        Ad Banner Placeholder (e.g., 728x90 or Responsive)
      </div>

      <div class="content-wrapper">
        <!-- Input Section -->
        <div class="input-section">
          <div class="form-group">
            <label for="textInput">Text or URL:</label>
            <textarea
              id="textInput"
              placeholder="Enter the text or URL you want to encode..."
            ></textarea>
          </div>

          <!-- Logo Input -->
          <div class="form-group">
            <label for="logoInput">Optional Logo Image:</label>
            <input
              type="file"
              id="logoInput"
              accept="image/png, image/jpeg, image/gif"
            />
            <div class="logo-preview-container">
              <img id="logoPreview" alt="Logo Preview" />
              <button id="clearLogoBtn">Clear</button>
              <span class="logo-tip"
                >Tip: Use a square image (e.g., 100x100px). Logo reduces QR
                readability.</span
              >
            </div>
          </div>

          <button id="generateBtn">Generate QR Code</button>
        </div>

        <!-- Preview Section -->
        <div class="preview-section">
          <h2>Preview</h2>
          <div id="qrcode">
            <!-- QR code canvas will be generated here -->
            <span style="color: #aaa">QR code will appear here</span>
          </div>
          <button id="downloadBtn" disabled>Download QR Code</button>
        </div>
      </div>
    </div>
    <!-- /container -->

    <footer>
      Powered by
      <a
        href="https://github.com/davidshimjs/qrcodejs"
        target="_blank"
        rel="noopener noreferrer"
        >qrcode.js</a
      >
      | Simple Generator
    </footer>

    <script>
      // Wait for the entire window to load
      window.addEventListener("load", (event) => {
        if (typeof QRCode === "undefined") {
          alert("Critical Error: QR Code library (qrcode.js) failed to load.");
          console.error("QRCode (from qrcode.js) is undefined.");
          return;
        } else {
          console.log("qrcode.js library loaded successfully.");
        }

        // Get DOM elements
        const textInput = document.getElementById("textInput");
        const logoInput = document.getElementById("logoInput");
        const logoPreview = document.getElementById("logoPreview");
        const clearLogoBtn = document.getElementById("clearLogoBtn");
        const generateBtn = document.getElementById("generateBtn");
        const qrcodeContainer = document.getElementById("qrcode");
        const downloadBtn = document.getElementById("downloadBtn");

        let currentQRCodeInstance = null; // Holds the qrcode.js instance (less critical now)
        let logoFile = null; // Holds the logo File object or data URL
        let generatedCanvas = null; // Holds the final canvas element displayed in #qrcode

        // --- Logo Handling ---
        logoInput.addEventListener("change", handleLogoSelect);
        clearLogoBtn.addEventListener("click", clearLogo);

        function handleLogoSelect(event) {
          const file = event.target.files[0];
          if (file && file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = function (e) {
              logoFile = e.target.result; // Store data URL
              logoPreview.src = logoFile;
              logoPreview.style.display = "inline-block";
              clearLogoBtn.style.display = "inline-block";
              // If QR code exists, regenerate with logo
              if (
                generatedCanvas ||
                qrcodeContainer.querySelector("canvas") ||
                qrcodeContainer.querySelector("img")
              ) {
                // Regenerate only if there's text present
                if (textInput.value.trim()) {
                  generateQRCode();
                }
              }
            };
            reader.onerror = () => {
              alert("Error reading logo file.");
              clearLogo();
            };
            reader.readAsDataURL(file);
          } else {
            if (file) {
              // If a file was selected but wasn't an image
              alert("Please select a valid image file (PNG, JPG, GIF).");
            }
            clearLogo(); // Clear if invalid or no file
          }
        }

        function clearLogo() {
          const needsRegeneration = !!logoFile; // Check if a logo was actually set before clearing
          logoFile = null;
          logoInput.value = ""; // Clear the file input visually
          logoPreview.src = "";
          logoPreview.style.display = "none";
          clearLogoBtn.style.display = "none";
          // If QR code exists and we just removed a logo, regenerate without logo
          // Only regenerate if there's text present
          if (
            (generatedCanvas ||
              qrcodeContainer.querySelector("canvas") ||
              qrcodeContainer.querySelector("img")) &&
            needsRegeneration &&
            textInput.value.trim()
          ) {
            generateQRCode();
          } else if (!textInput.value.trim()) {
            // Also clear preview if text is empty
            qrcodeContainer.innerHTML =
              '<span style="color: #aaa;">QR code will appear here</span>';
            downloadBtn.disabled = true;
            generatedCanvas = null;
            currentQRCodeInstance = null;
          }
        }

        // --- QR Code Generation & Logo Drawing ---
        generateBtn.addEventListener("click", generateQRCode);

        function generateQRCode() {
          const text = textInput.value.trim();
          if (!text) {
            alert("Please enter text or a URL.");
            textInput.focus();
            return;
          }

          // Clear previous QR code and reset state
          qrcodeContainer.innerHTML = "";
          generatedCanvas = null; // Reset final canvas reference
          downloadBtn.disabled = true;
          currentQRCodeInstance = null; // Reset instance

          // Display placeholder
          const placeholder = document.createElement("span");
          placeholder.style.color = "#aaa";
          placeholder.textContent = "Generating...";
          qrcodeContainer.appendChild(placeholder);

          try {
            // 1. Generate Base QR Code using qrcode.js (might add img/canvas to container)
            currentQRCodeInstance = new QRCode(qrcodeContainer, {
              text: text,
              width: 250, // Target size for the QR code drawing
              height: 250,
              colorDark: "#000000",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.H, // High correction level is crucial for logos
            });

            // Short delay to allow qrcode.js to render the canvas/img
            setTimeout(() => {
              // Find the elements generated by qrcode.js
              const originalCanvas = qrcodeContainer.querySelector("canvas");
              const originalImg = qrcodeContainer.querySelector("img");

              // Determine the source element (prefer canvas)
              let sourceElement = originalCanvas || originalImg;

              if (!sourceElement) {
                // Clear placeholder if generation failed completely
                const currentPlaceholder =
                  qrcodeContainer.querySelector("span");
                if (
                  currentPlaceholder &&
                  currentPlaceholder.textContent === "Generating..."
                ) {
                  qrcodeContainer.removeChild(currentPlaceholder);
                }
                throw new Error(
                  "qrcode.js did not generate a canvas or image."
                );
              }

              // Create our definitive canvas to display and draw on
              generatedCanvas = document.createElement("canvas");
              generatedCanvas.width = 250; // Match generation size
              generatedCanvas.height = 250;
              const ctx = generatedCanvas.getContext("2d");

              // Draw the content from qrcode.js (canvas or img) onto our canvas
              try {
                // Ensure image is loaded before drawing if it's an img element
                if (
                  sourceElement.tagName === "IMG" &&
                  !sourceElement.complete
                ) {
                  console.log(
                    "Waiting for generated image to load before drawing..."
                  );
                  sourceElement.onload = () => {
                    ctx.drawImage(
                      sourceElement,
                      0,
                      0,
                      generatedCanvas.width,
                      generatedCanvas.height
                    );
                    processCanvasAfterDrawing(); // Continue processing after image loads
                  };
                  sourceElement.onerror = () => {
                    throw new Error("Generated image failed to load.");
                  };
                } else {
                  ctx.drawImage(
                    sourceElement,
                    0,
                    0,
                    generatedCanvas.width,
                    generatedCanvas.height
                  );
                  processCanvasAfterDrawing(); // Process immediately if canvas or img already loaded
                }
              } catch (drawError) {
                console.error(
                  "Error drawing generated QR code onto final canvas:",
                  drawError
                );
                qrcodeContainer.innerHTML = ""; // Clear placeholder etc.
                throw new Error("Failed to process generated QR code image.");
              }
            }, 100); // Delay for qrcode.js rendering
          } catch (error) {
            console.error("QR Code generation failed:", error);
            qrcodeContainer.innerHTML = `<span style="color: red;">Error: ${
              error.message || "Failed to generate QR code."
            }</span>`;
            alert("Could not generate QR code. Check console.");
            downloadBtn.disabled = true;
          }
        }

        // Helper function to avoid code duplication after drawing QR image to canvas
        function processCanvasAfterDrawing() {
          // *** Crucial Step: Update the preview container ***
          qrcodeContainer.innerHTML = ""; // Clear whatever qrcode.js put there/placeholder
          qrcodeContainer.appendChild(generatedCanvas); // Add OUR canvas

          // Now, if a logo exists, draw it onto the canvas we just appended
          if (logoFile) {
            drawLogoOnCanvas(); // This will now modify the visible canvas
          } else {
            // No logo, enable download for the base QR code (already visible)
            downloadBtn.disabled = false;
            console.log("Base QR Code generated and displayed (no logo).");
          }
        }

        function drawLogoOnCanvas() {
          // Must have the final canvas and logo data
          if (!generatedCanvas || !logoFile) {
            console.warn(
              "Attempted to draw logo, but canvas or logo file is missing."
            );
            // Enable download for base QR code if canvas exists but logo failed somehow
            if (generatedCanvas) downloadBtn.disabled = false;
            return;
          }

          // Disable download until logo is drawn successfully
          downloadBtn.disabled = true;

          const ctx = generatedCanvas.getContext("2d");
          const logoImage = new Image();

          logoImage.onload = () => {
            try {
              // Wrap drawing operations in try-catch
              const qrCodeSize = generatedCanvas.width;
              const logoTargetSize = qrCodeSize * 0.28;
              let logoDrawWidth = logoTargetSize;
              let logoDrawHeight = logoTargetSize;

              const aspectRatio =
                logoImage.naturalWidth / logoImage.naturalHeight;
              if (aspectRatio > 1) {
                logoDrawHeight = logoTargetSize / aspectRatio;
              } else {
                logoDrawWidth = logoTargetSize * aspectRatio;
              }

              const dx = (qrCodeSize - logoDrawWidth) / 2;
              const dy = (qrCodeSize - logoDrawHeight) / 2;

              const bgPadding = 4;
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(
                dx - bgPadding,
                dy - bgPadding,
                logoDrawWidth + bgPadding * 2,
                logoDrawHeight + bgPadding * 2
              );

              ctx.drawImage(logoImage, dx, dy, logoDrawWidth, logoDrawHeight);

              console.log("Logo drawn onto QR Code canvas.");
              downloadBtn.disabled = false; // Enable download *after* successful logo drawing
            } catch (drawingError) {
              console.error("Error drawing logo onto canvas:", drawingError);
              alert(
                "An error occurred while drawing the logo onto the QR code."
              );
              // Enable download for the base QR code even if logo drawing failed
              downloadBtn.disabled = false;
            }
          };

          logoImage.onerror = () => {
            console.error("Failed to load logo image for drawing.");
            alert(
              "Error loading the logo image. Displaying QR code without logo."
            );
            // Enable download for the base QR code if logo fails to load
            downloadBtn.disabled = false;
          };

          logoImage.src = logoFile;
        }

        // --- Download Functionality ---
        downloadBtn.addEventListener("click", () => {
          if (generatedCanvas) {
            // Check the final canvas reference
            const dataUrl = generatedCanvas.toDataURL("image/png");
            const link = document.createElement("a");
            link.href = dataUrl;
            link.download = logoFile ? "qrcode_with_logo.png" : "qrcode.png"; // Change filename if logo exists
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } else {
            alert("Please generate a QR code first.");
            console.error("Download clicked but no generatedCanvas found.");
          }
        });

        // --- Optional: Clear preview if text is cleared ---
        textInput.addEventListener("input", () => {
          if (textInput.value.trim() === "") {
            qrcodeContainer.innerHTML =
              '<span style="color: #aaa;">QR code will appear here</span>';
            downloadBtn.disabled = true;
            generatedCanvas = null;
            currentQRCodeInstance = null;
          }
        });
      }); // End of window.onload listener
    </script>
  </body>
</html>
